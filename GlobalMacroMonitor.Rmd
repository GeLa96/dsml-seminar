---
title: "Global Macro Monitor"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: cerulean
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(dplyr)
library(tidyr)
library(ggplot2)
library(plotly)
options(scipen = 999)

options(bitmapType="cairo"); options(warn=-1)

# ==========================
# 1) LOAD DATA
# ==========================
load("~/Data")


# vector of indicators
indicator <- data %>% select(-Economy, -Year) %>% names()

# vector of all economies
economy <- sort(unique(data$Economy))

# first and las year
firstYear <- min(data$Year, na.rm = TRUE)
lastYear <- max(data$Year, na.rm = TRUE)

# function to filter first to last year to show
filterFirstToLastYear <- function(d, r) d %>% filter(Year >= r[1], Year <= r[2])

# starting Parameters
economySelected <- c("Germany","Austria","France","China")

```


Sidebar {.sidebar}
-------------------------------------

### Input Parameters

```{r}
selectizeInput("countries", "Countries (bottom chart)",choices = economy,multiple = TRUE,selected = economySelected,options = list(placeholder = "Select countries")
)

selectizeInput("country_top", "Country (top chart)",choices = economy,multiple = FALSE,selected = economySelected[[1]])

selectizeInput("indicators", "Indicators (top bars)",choices = setNames(indicator, indicator),multiple = TRUE,selected = "OutwardStock")

selectizeInput("indicator_one", "Indicator (bottom)",choices = setNames(indicator, indicator),selected = indicator[[1]], multiple = FALSE)

sliderInput("yearRange", "Years", min = firstYear, max = lastYear,value = c(max(firstYear, lastYear - 10), lastYear), step = 1, sep = "")

```

```{r}

# convert data to long format
longData <- data %>% select(Economy, Year, all_of(indicator)) %>% pivot_longer(-c(Economy, Year), names_to = "Indicator", values_to = "Value")

# calculate chane in %
changeData <- longData %>% group_by(Economy, Indicator) %>% mutate(changeValue = 100 * (Value / lag(Value) - 1)) %>% ungroup()

# Reactives variables
longDataR      <- reactive({longData})
longchangeData  <- reactive({changeData})

# reactive function to filter year and economies
filterYearAndCountry <- reactive({
  req(input$yearRange)
  data <- changeData %>% filterFirstToLastYear(input$yearRange)
  if (!is.null(input$countries) && length(input$countries) > 0) {
    data <- data %>% filter(Economy %in% input$countries)
  }
  data
})

# reactive function to calculate changes for Economy == World
calcGlobalChange <- function(longData, indicytor) {
  longData %>% filter(Indicator == indicytor, Economy == "World") %>% mutate( World = 100 * (Value / lag(Value) - 1)) %>% select(Year, World)
}
```

Row
-------------------------------------

### Time series: Indicators (bars) vs GDP (line) {data-height=450}

```{r}
renderPlotly({
  req(input$country_top, input$indicators)

  # Bars: chosen country (alle au√üer GDP)
  bars_inds <- setdiff(input$indicators, "Gdp")
  validate(need(length(bars_inds) > 0, "Please select at least one non-Gdp indicator for bars."))

  bars <- longchangeData() %>%
    filter(Economy == input$country_top, Indicator %in% bars_inds) %>%
    filterFirstToLastYear(input$yearRange) %>%
    transmute(Year = as.integer(Year), Indicator, value = changeValue) %>%
    filter(!is.na(value) & is.finite(value)) %>%
    mutate(hover = paste0(
      Indicator, "<br>Year: ", Year,
      "<br>Change: ", scales::label_number(accuracy = 0.1)(value)
    ))

  # GDP line
  gdp_line <- longchangeData() %>%
    filter(Economy == input$country_top, Indicator == "Gdp") %>%
    filterFirstToLastYear(input$yearRange) %>%
    transmute(Year = as.integer(Year), Gdp = changeValue) %>%
    filter(!is.na(Gdp) & is.finite(Gdp)) %>%
    mutate(hover = paste0(
      "GDP", "<br>Year: ", Year,
      "<br>Change: ", scales::label_number(accuracy = 0.1)(Gdp)
    ))

  validate(need(nrow(bars) > 0, "No bar data available for the selected filters."))
  validate(need(nrow(gdp_line) > 0, "No GDP series available for the selected filters."))

  rng <- range(c(bars$value, gdp_line$Gdp), na.rm = TRUE)

  p <- ggplot() +
    geom_col(
      data = bars,
      aes(x = Year, y = value, fill = Indicator, text = hover),
      position = "stack", width = 0.9, alpha = 0.9
    ) +
    geom_line(
      data = gdp_line,
      aes(x = Year, y = Gdp, group = 1, text = hover),
      linewidth = 0.7, color = "#2B2D42"
    ) +
    geom_point(
      data = gdp_line,
      aes(x = Year, y = Gdp, text = hover),
      size = 2.2, color = "#2B2D42"
    ) +
    scale_fill_brewer(palette = "Set2") +
    labs(x = NULL, y = "Change in %", fill = NULL) +
    coord_cartesian(ylim = rng, expand = FALSE) +
    theme_minimal(base_size = 13) +
    theme(
      plot.background   = element_rect(fill = "white",  color = NA),
      panel.background  = element_rect(fill = "#F7F7F7", color = NA),
      panel.grid.major  = element_line(color = "#E1E1E1", linewidth = 0.4),
      panel.grid.minor  = element_line(color = "#EFEFEF", linewidth = 0.2),
      axis.title.y      = element_text(margin = margin(r = 8)),
      legend.position   = "bottom",
      legend.key        = element_rect(fill = NA, color = NA)
    )

  ggplotly(p, tooltip = "text") %>%
    layout(
      hovermode = "x unified",
      legend = list(orientation = "h", y = -0.15)
    )
})

```

Row
-------------------------------------

### Time series: countries (bars) & World (line) {data-height=500}

```{r}
renderPlotly({
  req(input$indicator_one)
  ind <- input$indicator_one

  # Bars: filtered countries & years
  bars <- filterYearAndCountry() %>%filter(Indicator == ind, Economy != "World") %>%transmute(Economy, Year = as.integer(Year), value = changeValue) %>% filter(!is.na(value) & is.finite(value))

  # World line
  world <- calcGlobalChange(longDataR(), ind) %>%filterFirstToLastYear(input$yearRange) %>%mutate(Year = as.integer(Year)) %>% filter(!is.na(World) & is.finite(World))

  validate(need(nrow(bars) > 0, "No country data for selected filter."))
  validate(need(nrow(world) > 0, "No 'World' series available for selected filter."))

  rng <- range(c(bars$value, world$World), na.rm = TRUE)

  # text formats
  bars <- bars %>%mutate(hover = paste0(Economy, "<br>Year: ", Year,"<br>Change: ", scales::label_number(accuracy = 0.1)(value)))
  world <- world %>%mutate(hover = paste0("World", "<br>Year: ", Year,"<br>Change: ", scales::label_number(accuracy = 0.1)(World)))

  p <- ggplot() +
    geom_col(
      data = bars,
      aes(x = Year, y = value, fill = Economy, text = hover),
      position = "stack", width = 0.9, alpha = 0.9
    ) +
    geom_line(
      data = world,
      aes(x = Year, y = World, group = 1, text = hover),
      linewidth = 0.7, color = "#2B2D42"
    ) +
    geom_point(
      data = world,
      aes(x = Year, y = World, text = hover),
      size = 2.2, color = "#2B2D42"
    ) +
    # Farbpalette (ggplot Standardpakete)
    scale_fill_brewer(palette = "Set2") +
    labs(x = NULL, y = "Change in %", fill = NULL) +
    coord_cartesian(ylim = rng, expand = FALSE) +
    theme_minimal(base_size = 13) +
    theme(
      plot.background   = element_rect(fill = "white",  color = NA),
      panel.background  = element_rect(fill = "#F7F7F7", color = NA),
      panel.grid.major  = element_line(color = "#E1E1E1", linewidth = 0.4),
      panel.grid.minor  = element_line(color = "#EFEFEF", linewidth = 0.2),
      axis.title.y      = element_text(margin = margin(r = 8)),
      legend.position   = "bottom",
      legend.key        = element_rect(fill = NA, color = NA)
    )

  ggplotly(p, tooltip = "text") %>%
    layout(
      hovermode = "x unified",
      legend = list(orientation = "h", y = -0.15)
    )
})

```
